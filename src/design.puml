@startuml OrderBookSystemDesign
!theme plain
skinparam backgroundColor #FFFFFF
allowmixing

title Order Book System Architecture

package "sender_main (process)" as SenderProc {
    class TCPSender {
        - port_
        - batchSize_
        - dataFile_
        - serverSocket_
        - clientSocket_
        - streaming_
        - sentMessages_
        - startTime_
        - endTime_
    }
    
    class BatchBuffer {
        buffer
        capacity
    }
    
    class PreParsedMessages {
        allMessages
        capacity
    }
    
    class DbnFileStore
}

package "StreamingThread" {
    class StreamingThread {
        streamingLoop
    }
}

package "Network Layer" {
    class TCPConnection
    class KernelBuffers {
        sendBuffer
        recvBuffer
    }
}

package "receiver_main (process)" as ReceiverProc {
    class TCPReceiver {
        - clientSocket_
        - orderBook_
        - jsonRingBuffer_
        - jsonBuffer_
        - jsonBufferMutex_
        - jsonFile_
        - orderBookMutex_
        - orderProcessTimesNs_
    }
    
    class RingBuffer {
        buffer_
        capacity
        read_pos_
        write_pos_
    }
    
    class JSONBuffer {
        buffer
        capacity
        mutex
    }
    
    class Book {
        - bidLevels
        - askLevels
        - mutex
    }
    
}

package "ReceivingThread" {
    class ReceivingThread {
        receivingLoop
    }
}

package "JSONThread" {
    class JSONThread {
        jsonGenerationLoop
    }
}

file DBNFile
file JSONFile

' Thread 1: Sender Streaming Thread - One-way data flow
DBNFile --> DbnFileStore : reads file
DbnFileStore --> StreamingThread : provides records
StreamingThread --> PreParsedMessages : populates allMessages
PreParsedMessages --> StreamingThread : reads messages
StreamingThread --> BatchBuffer : accumulates batchBuffer
BatchBuffer --> StreamingThread : reads for sending
StreamingThread --> TCPSender : writes via clientSocket_
TCPSender --> TCPConnection : writev

' Network Layer - One-way data flow
TCPConnection --> KernelBuffers : buffers
KernelBuffers --> ReceivingThread : delivers via socket

' Thread 2: Receiver Receiving Thread - One-way data flow
TCPReceiver --> ReceivingThread : provides clientSocket_
ReceivingThread --> Book : applies updates
ReceivingThread --> RingBuffer : push MboMessageWrapper

' Thread 3: Receiver JSON Thread - One-way data flow
RingBuffer --> JSONThread : pop MboMessageWrapper
JSONThread --> Book : reads snapshot
JSONThread --> JSONBuffer : batches JSON
JSONBuffer --> JSONFile : writes file

@enduml